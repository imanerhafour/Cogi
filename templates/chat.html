{% extends 'base.html' %}

{% block title %}Chat with Cogi{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">

    <!-- Sidebar historique -->
    <div class="col-md-3">
      <div class="list-group">
        <h5 class="mb-3">ðŸ•˜ Chat History</h5>
        {% for convo in sessions %}
          <a href="{{ url_for('chat', session_id=convo.id) }}" class="list-group-item list-group-item-action {% if convo.id == active_id %}active{% endif %}">
            {{ convo.timestamp.strftime('%d/%m %H:%M') }}
          </a>
        {% endfor %}
        <a href="{{ url_for('chat', new='1') }}" class="btn btn-sm btn-outline-success mt-3">âž• New Chat</a>
      </div>
    </div>

    <!-- Chat principal -->
    <div class="col-md-9">
      <div class="chat-container">

        <!-- Zone d'affichage des messages -->
        <div id="chat-box" class="chat-box">
          <!-- Message de bienvenue -->
          <div class="chat-message bot-message fade-in">
            <div class="message-avatar">
              <i class="bi bi-robot"></i>
            </div>
            <div class="message-content">
              <div class="message-sender">Cogi</div>
              <div class="message-text">
                Hello {{ first_name }} {{ last_name }}! How can I help you today? I'm here to talk about whatever is on your mind.
              </div>
            </div>
          </div>

          <!-- Historique des messages -->
          {% if history %}
            {% for msg in history %}
              <div class="chat-message {% if msg[1] == 'user' %}user-message{% else %}bot-message{% endif %} fade-in">
                <div class="message-avatar">
                  {% if msg[1] == 'user' %}
                    <i class="bi bi-person-circle"></i>
                  {% else %}
                    <i class="bi bi-robot"></i>
                  {% endif %}
                </div>
                <div class="message-content">
                  <div class="message-sender">{{ msg[1] | capitalize }}</div>
                  <div class="message-text">{{ msg[0] }}</div>
                  <div class="message-time">{{ msg[2] }}</div>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>

        <!-- Champ de saisie utilisateur -->
        <div class="chat-input p-3">
          <form method="POST" action="/chat" id="message-form" class="d-flex align-items-center gap-2 no-wrap">
            <input type="text" id="user-input" name="message" class="form-control flex-grow-1" placeholder="Type your message here..." autocomplete="off" required>
            
            <button type="button" id="micBtn" class="btn btn-mic">
              <i class="bi bi-mic"></i>
            </button>
        
            <div id="voice-status" class="voice-status">Micro: inactif</div>
        
            <button type="submit" id="send-btn" class="btn btn-love d-flex align-items-center gap-1">
              <i class="bi bi-send-fill"></i> <span>Send</span>
            </button>
          </form>
        
          <!-- Suggestions -->
          <div class="chat-suggestions d-flex gap-2 mt-3 flex-wrap justify-content-center">
            <span class="tag tag-love suggestionBtn">I feel anxious</span>
            <span class="tag tag-peace suggestionBtn">Breathing techniques</span>
            <span class="tag tag-harmony suggestionBtn">How can I improve my mood?</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  // Pour tous les boutons de suggestion
  document.querySelectorAll(".suggestionBtn").forEach(function(btn) {
    btn.addEventListener("click", function() {
      const messageInput = document.getElementById("user-input");
      messageInput.value = btn.textContent;  // insÃ¨re le texte dans l'input
      messageInput.focus();  // met le curseur dedans
    });
  });
</script>

{% endblock %}
