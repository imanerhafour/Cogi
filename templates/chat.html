{% extends 'base.html' %}

{% block title %}Chat with Cogi{% endblock %}

{% block content %}
<div class="chat-container">
  <!-- Zone d'affichage des messages -->
  <div id="chat-box" class="chat-box">
    <!-- Message de bienvenue -->
    <div class="chat-message bot-message fade-in">
      <div class="message-avatar">
        <i class="bi bi-robot"></i>
      </div>
      <div class="message-content">
        <div class="message-sender">Cogi</div>
        <div class="message-text">
          Hello {{ first_name }} {{ last_name }}! How can I help you today? I'm here to talk about whatever is on your mind.
        </div>
      </div>
    </div>
  </div>

  <!-- Champ de saisie utilisateur -->
  <div class="chat-input glass-card">
    <form id="message-form" class="input-group">
      <input type="text" id="user-input" class="form-control" placeholder="Type your message here..." autocomplete="off">
      <button type="button" id="micBtn" class="btn btn-mic">
        <i class="bi bi-mic"></i>
      </button>
      <div id="voice-status" class="voice-status">Micro: inactif</div>
      <button type="submit" id="send-btn" class="btn btn-love">
        <i class="bi bi-send-fill"></i> Send
      </button>
    </form>
    <div class="chat-suggestions mt-3">
      <span class="tag tag-love suggestionBtn">I feel anxious</span>
      <span class="tag tag-peace suggestionBtn">Breathing techniques</span>
      <span class="tag tag-harmony suggestionBtn">How can I improve my mood?</span>
    </div>
  </div>
</div>

<script>
  function sendMessage(message = null) {
    const input = document.getElementById("user-input");
    const userMessage = message || input.value.trim();
    if (userMessage === "") return;

    appendMessage("You", userMessage, true);
    input.value = "";

    const typingIndicator = document.createElement("div");
    typingIndicator.id = "typing-indicator";
    typingIndicator.classList.add("chat-message", "bot-message", "fade-in");
    typingIndicator.innerHTML = `
      <div class="message-avatar"><i class="bi bi-robot"></i></div>
      <div class="message-content">
        <div class="message-sender">Cogi</div>
        <div class="message-text typing-animation">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
      </div>`;
    document.getElementById("chat-box").appendChild(typingIndicator);
    scrollToBottom();

    fetch("/send_message", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ message: userMessage })
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById("typing-indicator").remove();
      appendMessage("Cogi", data.reply || "❌ Erreur : réponse vide", false);
    })
    .catch(error => {
      console.error("Erreur :", error);
      document.getElementById("typing-indicator").remove();
      appendMessage("Cogi", "⚠️ Une erreur est survenue. Veuillez réessayer.", false);
    });
  }

  function appendMessage(sender, message, isUser) {
    const chatBox = document.getElementById("chat-box");
    const msg = document.createElement("div");
    msg.classList.add("chat-message", "fade-in", isUser ? "user-message" : "bot-message");

    msg.innerHTML = isUser
      ? `<div class="message-content"><div class="message-sender">${sender}</div><div class="message-text">${message}</div></div>
         <div class="message-avatar"><i class="bi bi-person"></i></div>`
      : `<div class="message-avatar"><i class="bi bi-robot"></i></div>
         <div class="message-content"><div class="message-sender">${sender}</div><div class="message-text">${message}</div></div>`;

    chatBox.appendChild(msg);
    scrollToBottom();
  }

  function scrollToBottom() {
    const chatBox = document.getElementById("chat-box");
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  document.getElementById("message-form").addEventListener("submit", function (event) {
    event.preventDefault();
    sendMessage();
  });

  document.querySelectorAll(".suggestionBtn").forEach(btn => {
    btn.addEventListener("click", function () {
      sendMessage(this.textContent);
    });
  });

  window.onload = function () {
    document.getElementById("user-input").focus();
  };
</script>
{% endblock %}
